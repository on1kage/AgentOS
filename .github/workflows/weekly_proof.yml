name: agentos-weekly-proof

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  weekly-proof:
    runs-on: ubuntu-latest
    env:
      PPLX_API_KEY: \${{ secrets.PPLX_API_KEY }}
      PPLX_BASE_URL: \${{ secrets.PPLX_BASE_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: install
        run: pip install -r requirements.txt
      - name: run weekly proof
        run: PYTHONPATH=src:src/onemind-FSM-Kernel/src python3 tools/weekly_proof_run.py --intent utc_date --roles envoy,scout --require-scout
      - name: validate evidence hashes
        run: |
          set -euo pipefail
          dirs=(store/weekly_proof/utc_date/*/evidence)
          if [ "${#dirs[@]}" -eq 0 ]; then exit 1; fi
          for d in "${dirs[@]}"; do
            PYTHONPATH=src:src/onemind-FSM-Kernel/src python3 tools/validate_evidence.py --contract ci/evidence_contract.v1.json --evidence-root "$d"
          done
