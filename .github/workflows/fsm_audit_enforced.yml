name: FSM Audit + No Comment Enforcement

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  audit_and_enforce:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout OneMind Kernel
        uses: actions/checkout@v4
        with:
          repository: on1kage/onemind-FSM-Kernel
          path: onemind-FSM-Kernel
          token: ${{ secrets.ONEMINDKERNEL }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install package + test deps
        run: |
          set -euo pipefail
          python -m pip install -U pip
          python -m pip install -U pytest
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then python -m pip install -r requirements-dev.txt; fi

      - name: Run FSM audit
        env:
          ONEMIND_KERNEL_DIR: ${{ github.workspace }}/onemind-FSM-Kernel
        run: |
          set -euo pipefail
          bin/fsm_audit.sh

      - name: Enforce no comment lines in shell scripts
        run: |
          set -euo pipefail
          files=$(find . -type f -name "*.sh" -not -path "./onemind-FSM-Kernel/*")
          for f in $files; do
            awk 'NR==1 && $0 ~ /^#!/ {next} $0 ~ /^[[:space:]]*#/ {print "ERROR: Comment line in " FILENAME ":" NR; exit 1}' "$f"
          done

      - name: Run hermetic tests
        run: |
          set -euo pipefail
          PYTHONPATH=src pytest -q --disable-warnings tests_hermetic
      - name: Seed evidence bundle for CI validator
        run: |
          set -euo pipefail
          PYTHONPATH=src python3 -c "from pathlib import Path; from agentos.evidence import EvidenceBundle; from agentos.execution import ExecutionSpec; from agentos.outcome import ExecutionOutcome; root=Path('/tmp/agentos_evidence_ci'); (root.exists() and [q.unlink() if (q.is_file() or q.is_symlink()) else q.rmdir() for q in sorted(root.rglob('*'), reverse=True)]); root.mkdir(parents=True, exist_ok=True); ev=EvidenceBundle(str(root)); spec=ExecutionSpec(exec_id='exec_ci_0001', task_id='task_ci', role='envoy', action='deterministic_local_execution', kind='shell', cmd_argv=['/bin/echo','ok'], cwd='/tmp', env_allowlist=[], timeout_s=1, inputs_manifest_sha256='00'*32, paths_allowlist=['/tmp','/bin/echo'], note='ci validator seed'); ev.write_bundle(spec=spec, stdout=b'ok\\n', stderr=b'', outputs={}, outcome=ExecutionOutcome.SUCCEEDED, reason='exit_code:0', idempotency_key='k'); print('seeded', str(root))"


      - name: Validate evidence contract
        run: |
          set -euo pipefail
          PYTHONPATH=src python3 tools/validate_evidence.py --evidence-root /tmp/agentos_evidence_ci
