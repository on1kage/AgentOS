name: FSM Audit
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  audit:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: on1kage/onemind-FSM-Kernel
          path: onemind-FSM-Kernel
          fetch-depth: 1
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: python -m pip install -U pip
      - run: python -m pip install -e .
      - run: python -m pip install pytest
      - run: PYTHONPATH=src python -c "from pathlib import Path; from agentos.evidence import EvidenceBundle; from agentos.execution import ExecutionSpec; from agentos.outcome import ExecutionOutcome; root=Path('/tmp/agentos_evidence_ci'); import shutil; shutil.rmtree(root, ignore_errors=True); root.mkdir(parents=True, exist_ok=True); ev=EvidenceBundle(str(root)); spec=ExecutionSpec(exec_id='exec_ci_0001',task_id='task_ci',role='envoy',action='deterministic_local_execution',kind='shell',cmd_argv=['/bin/echo','ok'],cwd='/tmp',env_allowlist=[],timeout_s=1,inputs_manifest_sha256='0000000000000000000000000000000000000000000000000000000000000000',paths_allowlist=['/tmp','/bin/echo'],note='ci validator seed'); ev.write_bundle(spec=spec,stdout=b'ok\\n',stderr=b'',outputs={},outcome=ExecutionOutcome.SUCCEEDED,reason='exit_code:0',idempotency_key='k')"
      - run: PYTHONPATH=src python tools/validate_evidence.py --evidence-root /tmp/agentos_evidence_ci
      - run: PYTHONPATH=src python -m compileall -q src
      - run: PYTHONPATH=src pytest -q --disable-warnings --maxfail=1 tests_hermetic
      - run: PYTHONPATH=src python tools/validate_evidence.py --evidence-root /tmp/agentos_evidence_ci
      - env:
          ONEMIND_KERNEL_DIR: ${{ github.workspace }}/onemind-FSM-Kernel
        run: bash -euo pipefail bin/fsm_audit.sh
      - run: PYTHONPATH=src python tools/validate_evidence.py --evidence-root /tmp/agentos_evidence_ci
